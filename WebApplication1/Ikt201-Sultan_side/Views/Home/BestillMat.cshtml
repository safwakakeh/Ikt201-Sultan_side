@model IEnumerable<Ikt201_Sultan_side.Models.Dish>
@{
    ViewData["Title"] = "Bestill mat";
    var categories = Model.Select(d => d.Category).Distinct().OrderBy(c => c).ToList();
}

<div class="container meny-container mt-5 mb-5">

    <h1 class="text-center mb-3">Bestill mat</h1>
    <p class="text-center mb-4">
        Velg retter fra menyen og legg dem i handlekurven for å sende inn en bestilling.
    </p>

    <!-- FILTER -->
    <div class="meny-filter mb-4 text-center">
        <div class="mb-2">
            <span class="me-2 fw-semibold">Filtrer etter egenskaper:</span>

            <label class="me-3">
                <input type="checkbox" class="allergy-filter" data-filter="vegan" data-mode="property" />
                Vegansk
            </label>

            <label class="me-3">
                <input type="checkbox" class="allergy-filter" data-filter="halal" data-mode="property" />
                Halal
            </label>
        </div>

        <div class="mt-2">
            <span class="me-2 fw-semibold">Filtrer etter allergener (viser retter uten):</span>

            <label class="me-3">
                <input type="checkbox" class="allergy-filter" data-filter="gluten" data-mode="allergenFree" />
                Glutenfri
            </label>

            <label class="me-3">
                <input type="checkbox" class="allergy-filter" data-filter="melk" data-mode="allergenFree" />
                Laktosefri
            </label>

            <label class="me-3">
                <input type="checkbox" class="allergy-filter" data-filter="fisk" data-mode="allergenFree" />
                Uten fisk
            </label>

            <label class="me-3">
                <input type="checkbox" class="allergy-filter" data-filter="notter" data-mode="allergenFree" />
                Uten nøtter
            </label>

            <label class="me-3">
                <input type="checkbox" class="allergy-filter" data-filter="peanotter" data-mode="allergenFree" />
                Uten peanøtter
            </label>

            <label class="me-3">
                <input type="checkbox" class="allergy-filter" data-filter="egg" data-mode="allergenFree" />
                Uten egg
            </label>

            <label class="me-3">
                <input type="checkbox" class="allergy-filter" data-filter="skalldyr" data-mode="allergenFree" />
                Uten skalldyr
            </label>

            <label class="me-3">
                <input type="checkbox" class="allergy-filter" data-filter="soya" data-mode="allergenFree" />
                Uten soya
            </label>
        </div>
    </div>

    <!-- Kategori-navigasjon -->
    <div class="meny-nav-wrapper mb-4">
        <ul class="nav meny-nav justify-content-center flex-wrap">
            @foreach (var cat in categories)
            {
                var slug = cat.ToLower().Replace(" ", "-");
                <li class="nav-item">
                    <a class="nav-link" href="#@slug">@cat</a>
                </li>
            }
        </ul>
    </div>

    <div class="row g-4">

        <!-- VENSTRE SIDE: MENY MED "LEGG I KURV" -->
        <div class="col-lg-8">
            <div class="row g-4">
                @foreach (var cat in categories)
                {
                    var slug = cat.ToLower().Replace(" ", "-");
                    var dishesInCategory = Model.Where(d => d.Category == cat);

                    <div class="col-md-6" id="@slug">
                        <div class="card meny-card shadow-lg h-100">
                            <div class="card-body p-4">
                                <h3 class="section-title mb-3">@cat</h3>

                                @foreach (var dish in dishesInCategory)
                                {
                                    var allergens = dish.Allergens?.ToLower() ?? "";
                                    var hasGluten = allergens.Contains("gluten") ? "true" : "false";
                                    var hasMelk = allergens.Contains("melk") ? "true" : "false";
                                    var hasFisk = allergens.Contains("fisk") ? "true" : "false";
                                    var hasNotter = allergens.Contains("nøtter") ? "true" : "false";
                                    var hasPeanotter = allergens.Contains("peanøtter") ? "true" : "false";
                                    var hasEgg = allergens.Contains("egg") ? "true" : "false";
                                    var hasSkalldyr = allergens.Contains("skalldyr") ? "true" : "false";
                                    var hasSoya = allergens.Contains("soya") ? "true" : "false";
                                    
                                    // Use properties from database
                                    var isVegan = dish.IsVegan ? "true" : "false";
                                    var isHalal = dish.IsHalal ? "true" : "false";

                                    <div class="meny-item"
                                         data-name="@dish.Name"
                                         data-price="@dish.Price.ToString("0")"
                                         data-gluten="@hasGluten"
                                         data-melk="@hasMelk"
                                         data-fisk="@hasFisk"
                                         data-notter="@hasNotter"
                                         data-peanotter="@hasPeanotter"
                                         data-egg="@hasEgg"
                                         data-skalldyr="@hasSkalldyr"
                                         data-soya="@hasSoya"
                                         data-vegan="@isVegan"
                                         data-halal="@isHalal">
                                        @if (!string.IsNullOrEmpty(dish.ImagePath))
                                        {
                                            <img src="@dish.ImagePath" alt="@dish.Name" class="img-fluid rounded mb-2" style="max-height: 200px; object-fit: cover; width: 100%;">
                                        }
                                        <h5>@dish.Name <span class="pris">@dish.Price.ToString("0"),-</span></h5>
                                        <p>@dish.Description</p>
                                        <div class="meny-actions">
                                            <input type="number" class="form-control form-control-sm qty-input" value="1" min="1" />
                                            <button type="button" class="btn btn-sm btn-primary add-to-cart">Legg i kurv</button>
                                        </div>
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                }
            </div> <!-- /row -->
        </div>

        <!-- HØYRE SIDE: HANDLEKURV -->
        <div class="col-lg-4">
            <div class="card order-cart-card shadow-lg h-100">
                <div class="card-body p-4 d-flex flex-column">
                    <h3 class="section-title mb-3">Handlekurv</h3>

                    <div id="cart-empty" class="text-muted mb-2">
                        Kurven er tom.
                    </div>

                    <ul id="cart-items" class="list-unstyled flex-grow-1 mb-3"></ul>

                    <div class="d-flex justify-content-between mb-3 fw-bold">
                        <span>Sum:</span>
                        <span id="cart-total">0,-</span>
                    </div>

                    <button type="button" class="btn btn-primary w-100" id="checkout-btn" disabled>
                        Send bestilling
                    </button>
                </div>
            </div>
        </div>

    </div>
</div>
@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            /* ====== FILTER & DIMMING ====== */
            const checkboxes = document.querySelectorAll('.allergy-filter');
            const items = document.querySelectorAll('.meny-item');

            function applyFilters() {
                const activeFilters = Array.from(checkboxes)
                    .filter(cb => cb.checked)
                    .map(cb => ({
                        key: cb.getAttribute('data-filter'),
                        mode: cb.getAttribute('data-mode')
                    }));

                // Ingen filtre → alt normalt
                if (activeFilters.length === 0) {
                    items.forEach(item => {
                        item.style.opacity = "1";
                        item.style.fontWeight = "normal";
                    });
                    return;
                }

                items.forEach(item => {
                    const matchesAll = activeFilters.every(f => {
                        const attr = item.getAttribute('data-' + f.key);

                        if (f.mode === 'property') {
                            // Egenskap (vegan/halal): må ha data-xxx="true"
                            return attr === 'true';
                        } else if (f.mode === 'allergenFree') {
                            // Allergi-filter: vis retter UTEN allergenet
                            return attr !== 'true';
                        }
                        return true;
                    });

                    if (matchesAll) {
                        item.style.opacity = "1";
                        item.style.fontWeight = "700";
                    } else {
                        item.style.opacity = "0.35";
                        item.style.fontWeight = "normal";
                    }
                });
            }

            checkboxes.forEach(cb => cb.addEventListener('change', applyFilters));


            /* ====== HANDLEKURV ====== */
            const cart = {};
            const cartItemsEl = document.getElementById('cart-items');
            const cartTotalEl = document.getElementById('cart-total');
            const cartEmptyEl = document.getElementById('cart-empty');
            const checkoutBtn = document.getElementById('checkout-btn');

            function renderCart() {
                cartItemsEl.innerHTML = '';
                let total = 0;
                const entries = Object.values(cart);

                if (entries.length === 0) {
                    cartEmptyEl.style.display = 'block';
                    checkoutBtn.disabled = true;
                    cartTotalEl.textContent = '0,-';
                    return;
                }

                cartEmptyEl.style.display = 'none';
                checkoutBtn.disabled = false;

                entries.forEach(item => {
                    const li = document.createElement('li');
                    li.className = 'd-flex justify-content-between align-items-center mb-2';

                    const left = document.createElement('div');
                    left.innerHTML = `
                        <strong>${item.name}</strong><br>
                        <small>${item.qty} stk</small>
                    `;

                    const right = document.createElement('div');
                    right.className = "d-flex align-items-center gap-2";
                    right.innerHTML = `
                        <span>${item.price * item.qty},-</span>
                        <button class="btn btn-sm btn-danger remove-item" data-name="${item.name}">
                            ✕
                        </button>
                    `;

                    li.appendChild(left);
                    li.appendChild(right);
                    cartItemsEl.appendChild(li);

                    total += item.price * item.qty;
                });

                cartTotalEl.textContent = total + ',-';
            }

            // Legg til i kurv
            document.querySelectorAll('.add-to-cart').forEach(button => {
                button.addEventListener('click', function () {
                    const itemEl = this.closest('.meny-item');
                    const name = itemEl.getAttribute('data-name');
                    const price = parseInt(itemEl.getAttribute('data-price'));
                    const qtyInput = itemEl.querySelector('.qty-input');
                    const qty = parseInt(qtyInput.value) || 1;

                    if (!cart[name]) {
                        cart[name] = { name, price, qty };
                    } else {
                        cart[name].qty += qty;
                    }

                    qtyInput.value = 1;
                    renderCart();
                });
            });

            // Fjern fra kurv (event delegation)
            cartItemsEl.addEventListener('click', function (e) {
                if (e.target.classList.contains('remove-item')) {
                    const name = e.target.getAttribute('data-name');
                    delete cart[name];
                    renderCart();
                }
            });

            // Fake checkout
            checkoutBtn.addEventListener('click', function () {
                const items = Object.values(cart).map(item => ({
                    name: item.name,
                    price: item.price,
                    quantity: item.qty
                }));

                if (items.length === 0) {
                    alert('Handlekurven er tom.');
                    return;
                }

                fetch('/stripe/create-checkout-session', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ items: items })
                })
                    .then(async res => {
                        if (!res.ok) {
                            const text = await res.text();
                            console.error('Stripe-feil, status:', res.status, text);
                            throw new Error('Stripe-feil ' + res.status);
                        }
                        return res.json();
                    })
                    .then(({ url }) => {
                        window.location = url;
                    })
                    .catch(err => {
                        console.error('Feil i checkout:', err);
                        alert('Betalingen feilet.');
                    });
            });
        });
    </script>
}

