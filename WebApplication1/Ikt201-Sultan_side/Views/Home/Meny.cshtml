@model IEnumerable<Ikt201_Sultan_side.Models.Dish>
@{
    ViewData["Title"] = "Meny";
    var categories = Model.Select(d => d.Category).Distinct().OrderBy(c => c).ToList();
}

<div class="container meny-container mt-5 mb-5">

    <h1 class="text-center mb-3">Meny</h1>
    <p class="text-center mb-4">
        Utforsk våre retter – velg en kategori for å hoppe direkte dit.
    </p>

    <!-- Filter -->
    <div class="meny-filter mb-4 text-center">
        <div class="mb-2">
            <span class="me-2 fw-semibold">Filtrer etter egenskaper:</span>

            <label class="me-3">
                <input type="checkbox" class="allergy-filter" data-filter="vegan" data-mode="property" />
                Vegansk
            </label>

            <label class="me-3">
                <input type="checkbox" class="allergy-filter" data-filter="halal" data-mode="property" />
                Halal
            </label>
        </div>

        <div class="mt-2">
            <span class="me-2 fw-semibold">Filtrer etter allergener (viser retter uten):</span>

            <label class="me-3">
                <input type="checkbox" class="allergy-filter" data-filter="gluten" data-mode="allergenFree" />
                Glutenfri
            </label>

            <label class="me-3">
                <input type="checkbox" class="allergy-filter" data-filter="melk" data-mode="allergenFree" />
                Laktosefri
            </label>

            <label class="me-3">
                <input type="checkbox" class="allergy-filter" data-filter="fisk" data-mode="allergenFree" />
                Uten fisk
            </label>

            <label class="me-3">
                <input type="checkbox" class="allergy-filter" data-filter="notter" data-mode="allergenFree" />
                Uten nøtter
            </label>

            <label class="me-3">
                <input type="checkbox" class="allergy-filter" data-filter="peanotter" data-mode="allergenFree" />
                Uten peanøtter
            </label>

            <label class="me-3">
                <input type="checkbox" class="allergy-filter" data-filter="egg" data-mode="allergenFree" />
                Uten egg
            </label>

            <label class="me-3">
                <input type="checkbox" class="allergy-filter" data-filter="skalldyr" data-mode="allergenFree" />
                Uten skalldyr
            </label>

            <label class="me-3">
                <input type="checkbox" class="allergy-filter" data-filter="soya" data-mode="allergenFree" />
                Uten soya
            </label>
        </div>
    </div>

    <!-- Kategori-navigasjon -->
    <div class="meny-nav-wrapper mb-4">
        <ul class="nav meny-nav justify-content-center flex-wrap">
            @foreach (var cat in categories)
            {
                var slug = cat.ToLower().Replace(" ", "-");
                <li class="nav-item">
                    <a class="nav-link" href="#@slug">@cat</a>
                </li>
            }
        </ul>
    </div>

    <div class="row g-4">
        @foreach (var cat in categories)
        {
            var slug = cat.ToLower().Replace(" ", "-");
            var dishesInCategory = Model.Where(d => d.Category == cat);

            <div class="col-lg-6" id="@slug">
                <div class="card meny-card shadow-lg h-100">
                    <div class="card-body p-4">
                        <h3 class="section-title mb-3">@cat</h3>

                        @foreach (var dish in dishesInCategory)
                        {
                            var allergens = dish.Allergens?.ToLower() ?? "";
                            var hasGluten = allergens.Contains("gluten") ? "true" : "false";
                            var hasMelk = allergens.Contains("melk") ? "true" : "false";
                            var hasFisk = allergens.Contains("fisk") ? "true" : "false";
                            var hasNotter = allergens.Contains("nøtter") ? "true" : "false";
                            var hasPeanotter = allergens.Contains("peanøtter") ? "true" : "false";
                            var hasEgg = allergens.Contains("egg") ? "true" : "false";
                            var hasSkalldyr = allergens.Contains("skalldyr") ? "true" : "false";
                            var hasSoya = allergens.Contains("soya") ? "true" : "false";
                            
                            // Use properties from database
                            var isVegan = dish.IsVegan ? "true" : "false";
                            var isHalal = dish.IsHalal ? "true" : "false";

                            <div class="meny-item"
                                 data-gluten="@hasGluten"
                                 data-melk="@hasMelk"
                                 data-fisk="@hasFisk"
                                 data-notter="@hasNotter"
                                 data-peanotter="@hasPeanotter"
                                 data-egg="@hasEgg"
                                 data-skalldyr="@hasSkalldyr"
                                 data-soya="@hasSoya"
                                 data-vegan="@isVegan"
                                 data-halal="@isHalal">
                                @if (!string.IsNullOrEmpty(dish.ImagePath))
                                {
                                    <img src="@dish.ImagePath" alt="@dish.Name" class="img-fluid rounded mb-2" style="max-height: 200px; object-fit: cover; width: 100%;">
                                }
                                <h5>@dish.Name <span class="pris">@dish.Price.ToString("0"),-</span></h5>
                                <p>@dish.Description</p>
                            </div>
                        }
                    </div>
                </div>
            </div>
        }
    </div>
</div>

@section Scripts {
<script>
        document.addEventListener('DOMContentLoaded', function () {
            const checkboxes = document.querySelectorAll('.allergy-filter');
            const items = document.querySelectorAll('.meny-item');

            function applyFilters() {
                const activeFilters = Array.from(checkboxes)
                    .filter(cb => cb.checked)
                    .map(cb => ({
                        key: cb.getAttribute('data-filter'),
                        mode: cb.getAttribute('data-mode')
                    }));

                // Hvis ingen filtre valgt → reset alt
                if (activeFilters.length === 0) {
                    items.forEach(item => {
                        item.style.opacity = "1";
                        item.style.fontWeight = "normal";
                    });
                    return;
                }

                items.forEach(item => {
                    const matchesAll = activeFilters.every(f => {
                        const attr = item.getAttribute('data-' + f.key);

                        if (f.mode === 'property') {
                            return attr === 'true';
                        } 
                        else if (f.mode === 'allergenFree') {
                            return attr !== 'true';
                        }

                        return true;
                    });

                    if (matchesAll) {
                        // Highlight treff
                        item.style.opacity = "1";
                        item.style.fontWeight = "700";
                    } else {
                        // Dim ikke-treff
                        item.style.opacity = "0.35";
                        item.style.fontWeight = "normal";
                    }
                });
            }

            checkboxes.forEach(cb => {
                cb.addEventListener('change', applyFilters);
            });
        });
    </script>
}
}
